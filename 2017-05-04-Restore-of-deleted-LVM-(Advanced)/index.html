



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Official page of Anton Latukha">
      
      
        <link rel="canonical" href="https://blog.latukha.com/2017-05-04-Restore-of-deleted-LVM-(Advanced)/">
      
      
        <meta name="author" content="Anton Latukha">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon-min.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Restore of deleted LVM (Advanced) - Latukha: Good day my friend!</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.e194128b.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.3e3d1dff.css">
      
      
        
        
        <meta name="theme-color" content="#7e57c2">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CHack&display=fallback">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hack","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#restore-deleted-lvm-advanced" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://blog.latukha.com" title="Latukha: Good day my friend!" aria-label="Latukha: Good day my friend!" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../assets/images/favicon-min.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Latukha: Good day my friend!
            </span>
            <span class="md-header-nav__topic">
              
                Restore of deleted LVM (Advanced)
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Anton-Latukha/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Profile
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://blog.latukha.com" title="Latukha: Good day my friend!" class="md-nav__button md-logo">
      
        <img alt="logo" src="../assets/images/favicon-min.png" width="48" height="48">
      
    </a>
    Latukha: Good day my friend!
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Anton-Latukha/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Profile
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../bio/" title="Biography" class="md-nav__link">
      Biography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Articles
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../haskell-notes.html" title="Fundamental Haskell notes" class="md-nav__link">
      Fundamental Haskell notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../NixOS-HIE-Emacs/" title="Integrating NixOS/Nix, Haskell IDE Engine, Emacs" class="md-nav__link">
      Integrating NixOS/Nix, Haskell IDE Engine, Emacs
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Restore of deleted LVM (Advanced)
      </label>
    
    <a href="./" title="Restore of deleted LVM (Advanced)" class="md-nav__link md-nav__link--active">
      Restore of deleted LVM (Advanced)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-do-boot-sectot-backups" class="md-nav__link">
    How to do boot-sectot backups
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpt-case" class="md-nav__link">
    GPT case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mbr-case" class="md-nav__link">
    MBR case
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    LVM
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-info-on-lvm" class="md-nav__link">
    More info on LVM
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explaining-the-idea" class="md-nav__link">
    Explaining the idea
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process-of-restoring" class="md-nav__link">
    Process of restoring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-full-device" class="md-nav__link">
    Backup full device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choose-right-partition-table" class="md-nav__link">
    Choose right partition table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-of-the-system-long-operation" class="md-nav__link">
    Analyze of the system (long operation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-lvm-partition-with-testdisc" class="md-nav__link">
    Restoring LVM partition with TestDisc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebooting-system" class="md-nav__link">
    Rebooting system
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-state" class="md-nav__link">
    Checking state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-from-backup" class="md-nav__link">
    Restoring from backup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-reboot" class="md-nav__link">
    Next reboot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-make-partition-bootable" class="md-nav__link">
    (optional) Make partition bootable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mounting-everything-on-working-system-preparing-for-chroot" class="md-nav__link">
    Mounting everything on working system (preparing for chroot)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chrooting" class="md-nav__link">
    Chrooting
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-the-bootloader" class="md-nav__link">
    Setup the bootloader
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#congratulations" class="md-nav__link">
    Congratulations!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2017-04-14-How-to-setup-proxy-to-listen-Spotify/" title="How to setup proxy to listen Spotify" class="md-nav__link">
      How to setup proxy to listen Spotify
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2017-04-12-SaltStack-Formulas-install/" title="SaltStack formulas" class="md-nav__link">
      SaltStack formulas
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-do-boot-sectot-backups" class="md-nav__link">
    How to do boot-sectot backups
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpt-case" class="md-nav__link">
    GPT case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mbr-case" class="md-nav__link">
    MBR case
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    LVM
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-info-on-lvm" class="md-nav__link">
    More info on LVM
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explaining-the-idea" class="md-nav__link">
    Explaining the idea
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process-of-restoring" class="md-nav__link">
    Process of restoring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-full-device" class="md-nav__link">
    Backup full device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choose-right-partition-table" class="md-nav__link">
    Choose right partition table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-of-the-system-long-operation" class="md-nav__link">
    Analyze of the system (long operation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-lvm-partition-with-testdisc" class="md-nav__link">
    Restoring LVM partition with TestDisc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebooting-system" class="md-nav__link">
    Rebooting system
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-state" class="md-nav__link">
    Checking state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-from-backup" class="md-nav__link">
    Restoring from backup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-reboot" class="md-nav__link">
    Next reboot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-make-partition-bootable" class="md-nav__link">
    (optional) Make partition bootable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mounting-everything-on-working-system-preparing-for-chroot" class="md-nav__link">
    Mounting everything on working system (preparing for chroot)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chrooting" class="md-nav__link">
    Chrooting
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-the-bootloader" class="md-nav__link">
    Setup the bootloader
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#congratulations" class="md-nav__link">
    Congratulations!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/mkdocs-blog/tree/master/docs/2017-05-04-Restore-of-deleted-LVM-(Advanced).md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="restore-deleted-lvm-advanced">Restore deleted LVM (Advanced)<a class="headerlink" href="#restore-deleted-lvm-advanced" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Case of partition filesystem restore is much-much more trivial. It filesystem got corrupted - refer guides on that topic and use <strong>"TestDisc"</strong>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Intro</p>
<p>On the whole Internet until this post was no information on how to restore LVM, when no backup was present. <br/>
1. Do backups of the whole drive metadata. <br/>
2. On multiple drives - you would do <a href="#analyze-of-the-system-long-operation">Analyze</a> and <a href="#restoring-lvm-partition-with-testdisc">Restore</a> for all drives involved. <br/></p>
</div>
<p>So one way or another. Boot-sector and partition table are deleted from the drive.
If only that first sectors was erased, it is great, we can work hard and restore the LVM.</p>
<p>If happened the classic in sence of:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/dev/<span class="o">{</span>h,p,s<span class="o">}</span>d<span class="o">[</span>a..x<span class="o">]</span> <span class="nv">bs</span><span class="o">=</span><span class="m">512</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span>   <span class="c1"># Do not paste this to root prompt!</span>
<span class="c1"># Like:</span>
<span class="c1"># dd if=/dev/zero of=/dev/sda bs=512 count=1              # Do not paste this to root prompt!</span>
</pre></div>
</td></tr></table>

<h2 id="how-to-do-boot-sectot-backups">How to do boot-sectot backups<a class="headerlink" href="#how-to-do-boot-sectot-backups" title="Permanent link">&para;</a></h2>
<h3 id="gpt-case">GPT case<a class="headerlink" href="#gpt-case" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sgdisk -b<span class="o">=</span>/path/to/backup/drive-sgdisk.bak /path/to/device
</pre></div>
</td></tr></table>

<h3 id="mbr-case">MBR case<a class="headerlink" href="#mbr-case" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dd <span class="k">if</span><span class="o">=</span>/dev/<span class="o">[</span>hps<span class="o">]</span>d<span class="o">[</span>a-x<span class="o">]</span> <span class="nv">of</span><span class="o">=</span>/backup/<span class="o">[</span>hps<span class="o">]</span>d<span class="o">[</span>a-x<span class="o">]</span> <span class="nv">bs</span><span class="o">=</span><span class="m">512</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># Like:</span>
<span class="c1"># dd if=&#39;/dev/sda of=/backup/&#39;`date --iso`&#39;. sda&#39; bs=512 count=1</span>
</pre></div>
</td></tr></table>

<h2 id="lvm">LVM<a class="headerlink" href="#lvm" title="Permanent link">&para;</a></h2>
<p><img alt="LVM Logo" src="../assets/images/lvm_logo.svg" /></p>
<p>LVM complicates the task of recovery, because it is basically a dynamically shifting layer between physical drives partitions and filesystems.</p>
<p>Delete the LVM info - filesystem with data basically locked in a chaos claster you can not penetrate.</p>
<p>There is small info on Internet on how to resurrect your true HDD/SDD LVM friend(s) alive - but check that info anyway also.</p>
<p>Here is the black magic.</p>
<ol>
<li>If you understand LVM in depth. LVM dynamically allocates physical space pieces (Physical extent (PE)).<blockquote>
<p><strong>Physical extent (PE)</strong>
<p style="margin-left: 40px">The smallest size in the physical volume that can be assigned to a logical volume (default 4MiB))</p>
This is one of main facts here.</p>
</blockquote>
</li>
<li>Second fact - like most disc solutions - LVM does not shrink by itself.
We can do that process, if we want. But LVM, by itself, only expands.</li>
<li>Third fact - LVM does not move Physical extents (PE) around, they are statically placed. They allocated from free pool, given to Logical volume (LV), written in it info and that is it.</li>
</ol>
<p>But now you see. LVM is a array of Physical extent (PE), and they was allocated and information stored on them is a complete chaos to us and to tools of recovery (they does not support LVM). That is why it seems impossible to resurrect for most people. But with dedication, way is described here.</p>
<h3 id="more-info-on-lvm">More info on LVM<a class="headerlink" href="#more-info-on-lvm" title="Permanent link">&para;</a></h3>
<p>LVM maps Physical volumes (PV), to Volume groups (VG).</p>
<blockquote>
<p><strong>Physical volume (PV)</strong>
<p style="margin-left: 40px"> Partition on hard disk (or even the disk itself or loopback file) on which you can have volume groups. It has a special header and is divided into physical extents. Think of physical volumes as big building blocks used to build your hard drive. </p></p>
</blockquote>
<p><br/></p>
<blockquote>
<p><strong>Volume group (VG)</strong>
<p style="margin-left: 40px">  Group of physical volumes used as a storage volume (as one disk). They contain logical volumes. Think of volume groups as hard drives. </p></p>
</blockquote>
<p>On Volume group (VG) you can describe a Logical volume (LV).</p>
<blockquote>
<p><strong>Logical volume (LV)</strong>
<p style="margin-left: 40px"> A "virtual/logical partition" that resides in a volume group and is composed of physical extents. Think of logical volumes as normal partitions. </p></p>
</blockquote>
<p>And when Logical volume is going to need to expand its physical space, it does this by getting Physical extent (PE) and mapping it to Logical extent (LE) units, that then LVM includes to Logical volume (LV). It can expand until reaching quota, or free Volume group space available.</p>
<p>Logical extent (LE) units are additional abstraction for mapping LVM RAID PEs or PEs from different drives to single Logical volume.</p>
<p><img alt="LVM structure" src="../assets/images/lvm_struct.svg" /></p>
<h2 id="explaining-the-idea">Explaining the idea<a class="headerlink" href="#explaining-the-idea" title="Permanent link">&para;</a></h2>
<p>Besides corner stones described in <a href="#lvm">LVM</a>, next piece also plays as important part.</p>
<p>Not so known fact, LVM does a backups of it's work information.
In <code>/etc/lvm/backup</code> it stores last backup. In <code>/etc/lvm/archive</code> lays a history of previous backup versions.</p>
<p>But it is a backup inside the filesystem we trying to restore.</p>
<p>Here comes a dirty magic I was talking about.</p>
<p>If only we could revive LVM to any metadata state (even non-consistent), than almost certainly we can expect to get the hold of that <code>/etc/lvm/backup</code>. And it going to shine a lite on us.</p>
<p>TestDisc can find LVM partition remains, but TestDisc doesn't support work with LVM. It only can say: it looks like some version of LVM table. So TestDisc can't somehow find for us, what version of LVM structure it restores (old or last one), and how consistent that LVM data is.</p>
<p>So idea is. To revive the largest LVM TestDisc can find (probably the latest one, because LVM only expands most of the time and LVM PE data is static), and then <code>chroot</code> to that somewhat alive filesystem from working system and restore <code>/etc/lvm/backup</code>.</p>
<h2 id="process-of-restoring">Process of restoring<a class="headerlink" href="#process-of-restoring" title="Permanent link">&para;</a></h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For LVM on multiple drives - you must do <a href="#analyze-of-the-system-long-operation">Analyze</a> and <a href="#restoring-lvm-partition-with-testdisc">Restore</a> for all drives involved. After that next step - recovery - is going to be successful.</p>
</div>
<ul>
<li>Connect the drive to working system or boot from Live image <strong>that is compatible with distribution that you restore.</strong></li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>As I used Arch Linux on that machine, I used Arch based Antergos Live image. DD-t ISO on a flash drive. Antergos image has X11, Desktop Environment and Gparted prettiness.</p>
</div>
<ul>
<li>Install (update) <code>lvm2</code> and <code>testdisk</code>.
LVM2 as you guess provide LVM support.
TestDisk is magical but not intuitive tool.</li>
</ul>
<h3 id="backup-full-device">Backup full device<a class="headerlink" href="#backup-full-device" title="Permanent link">&para;</a></h3>
<p>Backup at least what is on the drive:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ddrescue -v -f -n /path/to/drive /backup/path /backup/path/rescue.log
</pre></div>
</td></tr></table></p>
<p>Because the process is somewhat nontrivial, long and uses a hack in it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>ddrescue</code> output <a href="https://superuser.com/questions/630951/why-is-it-impossible-to-compress-on-the-fly-images-by-ddrescue">can't be archived on the fly</a>. If you need compression - use filesystem level compression on the backup media. </p>
</div>
<h3 id="choose-right-partition-table">Choose right partition table<a class="headerlink" href="#choose-right-partition-table" title="Permanent link">&para;</a></h3>
<p>Choose here right type of the partition. It is up to your research. Probably you have one of: <code>[EFI GPT], [Mac ], [Intel ]</code>.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TestDisk 7.0, Data Recovery Utility, April 2015
Christophe GRENIER &lt;grenier@cgsecurity.org&gt;
http://www.cgsecurity.org


Disk /dev/sda - 1000 GB / 931 GiB - Hitachi HDS721010CLA330

Please select the partition table type, press Enter when done.
[Intel ] Intel/PC partition
&gt;[EFI GPT] EFI GPT partition map (Mac i386, some x86_64...)
[Humax ] Humax partition table
[Mac ] Apple partition map
[None ] Non partitioned media
[Sun ] Sun Solaris partition
[XBox ] XBox partition
[Return ] Return to disk selection
</pre></div>
</td></tr></table></p>
<p>Hint: Intel partition table type has been detected.
Note: Do NOT select 'None' for media with only a single partition. It's very
rare for a disk to be 'Non-partitioned'.</p>
<h3 id="analyze-of-the-system-long-operation">Analyze of the system (long operation)<a class="headerlink" href="#analyze-of-the-system-long-operation" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TestDisk 7.0, Data Recovery Utility, April 2015
Christophe GRENIER &lt;grenier@cgsecurity.org&gt;
http://www.cgsecurity.org


Disk /dev/sda - 1000 GB / 931 GiB - Hitachi HDS721010CLA330
 CHS 121601 255 63 - sector size=512

&gt;[ Analyse ] Analyse current partition structure and search for lost partitions
[ Advanced ] Filesystem Utils
[ Geometry ] Change disk geometry
[ Options ] Modify options
[ MBR Code ] Write TestDisk MBR code to first sector
[ Delete ] Delete all data in the partition table
[ Quit ] Return to disk selection
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Correct disk geometry is required for a successful recovery. 'Analyse' process may give some warnings if it thinks the logical geometry is mismatched.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TestDisk 7.0, Data Recovery Utility, April 2015
Christophe GRENIER &lt;grenier@cgsecurity.org&gt;
http://www.cgsecurity.org

Disk /dev/sda - 1000 GB / 931 GiB - CHS 121601 255 63
 Partition Start End Size in sectors
&gt;P Linux LVM 0 32 33 121601 90 25 1953523712
</pre></div>
</td></tr></table>

<p><br/></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TestDisk 7.0, Data Recovery Utility, April 2015
Christophe GRENIER &lt;grenier@cgsecurity.org&gt;
http://www.cgsecurity.org

Disk /dev/sda - 1000 GB / 931 GiB - CHS 121601 255 63

 Partition Start End Size in sectors

1 P Linux LVM 0 32 33 121601 90 25 1953523712
</pre></div>
</td></tr></table>

<p><br/></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TestDisk 7.0, Data Recovery Utility, April 2015
Christophe GRENIER &lt;grenier@cgsecurity.org&gt;
http://www.cgsecurity.org

Disk /dev/sda - 1000 GB / 931 GiB - CHS 121601 255 63
Analyse cylinder 553/121600: 00%


 Linux LVM 0 32 33 121601 80 63 1953523120
 Linux 0 65 2 13 0 51 204800
 Linux 0 64 63 13 0 49 204800
 Linux 0 64 63 13 0 49 204800
 Linux 0 64 63 13 0 49 204800
 Linux 0 64 63 13 0 49 204800
 Linux 0 64 63 13 0 49 204800
 Linux 13 0 52 3276 138 62 52428800






 Stop  
</pre></div>
</td></tr></table>

<h3 id="restoring-lvm-partition-with-testdisc">Restoring LVM partition with TestDisc<a class="headerlink" href="#restoring-lvm-partition-with-testdisc" title="Permanent link">&para;</a></h3>
<p>After that scan TestDisc review several partitions to restore. One of which is LVM. And it says drive is to small (1T&lt;1.3T or something like that) to reincarnate all that partitions. So you restore the LVM partition (the biggest).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>At this stage partition and filesystem can be in inconsistent state. Minimize writing to system and proceed further. Restore from backup is going to get us consistent filesystem.</p>
</div>
<h3 id="rebooting-system">Rebooting system<a class="headerlink" href="#rebooting-system" title="Permanent link">&para;</a></h3>
<p>To refresh drive boot-partition information - reboot after restoring.</p>
<h3 id="checking-state">Checking state<a class="headerlink" href="#checking-state" title="Permanent link">&para;</a></h3>
<p>After reboot while doing:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[antergos@ant-16.9 etc]$ lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda 8:0 0 931.5G 0 disk 
sda1 8:1 0 931.5G 0 part 
 archvg-boot 254:0 0 100M 0 lvm  
 archvg-archroot 254:1 0 25G 0 lvm /mnt/etc
 archvg-archvar 254:2 0 15G 0 lvm /run/media/antergos/244907d8-7c9f-
 archvg-swap 254:3 0 8G 0 lvm  
 archvg-vault 254:4 0 800G 0 lvm  
 archvg-crypt 254:5 0 1G 0 lvm  
 archvg-archhome 254:6 0 20G 0 lvm /run/media/antergos/e2d59443-1e66-
</pre></div>
</td></tr></table></p>
<p>You began to see:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[antergos@ant-16.9 etc]$ sudo vgscan
 Reading volume groups from cache.
 Found volume group &quot;archvg&quot; using metadata type lvm2
</pre></div>
</td></tr></table></p>
<h3 id="restoring-from-backup">Restoring from backup<a class="headerlink" href="#restoring-from-backup" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo -s

<span class="c1"># Change volume group attribute to activated</span>
vgchange -ay archvg

mkdir /mnt/root/

<span class="c1"># We need to mount only partition that has backup</span>
mount /dev/disk/by-id/archvg-root /mnt/root/

<span class="c1"># Locate/print block device attributes</span>
blkid /dev/sda1
<span class="c1"># /dev/sda1: UUID=&quot;7SFaGJ-LKnf-mlx7-m8dY-1bg4-epWM-09y8vR&quot; TYPE=&quot;LVM2_member&quot;</span>

<span class="c1"># Investigate backup. Compare with information above</span>
cat /mnt/root/etc/lvm/backup/archvg

<span class="c1"># Restore volume group configuration</span>
vgcfgrestore -f /mnt/root/etc/lvm/backup/archvg archvg
<span class="c1">#Metadata Restored</span>
</pre></div>
</td></tr></table>

<h3 id="next-reboot">Next reboot<a class="headerlink" href="#next-reboot" title="Permanent link">&para;</a></h3>
<p>Reboot.</p>
<p>After that, if you try to boot to recovered system, - you can get error:</p>
<blockquote>
<p>1234F:</p>
</blockquote>
<p>Because no bootloader was configured. Now we need boot from Live image once more.</p>
<h3 id="optional-make-partition-bootable">(optional) Make partition bootable<a class="headerlink" href="#optional-make-partition-bootable" title="Permanent link">&para;</a></h3>
<p>If you was booting from LVM.</p>
<p>Mark partition bootable (that flag was in old boot-sector, as you know old-one went away).
<code>sudo gparted</code>.
Right click on partition. Flags. "boot".</p>
<h3 id="mounting-everything-on-working-system-preparing-for-chroot">Mounting everything on working system (preparing for chroot)<a class="headerlink" href="#mounting-everything-on-working-system-preparing-for-chroot" title="Permanent link">&para;</a></h3>
<p>Now you need by yourself mount all LVM volumes to single tree in /mnt/root, exactly how it was on that system.
Because your LVM config is unique, as also mine, I can't give you literal instructions.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>I going to mount:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>archvg-archroot /mnt/root/
archvg-boot     /mnt/root/boot
archvg-archvar  /mnt/root/var
archvg-archhome /mnt/root/home
archvg-vault    /mnt/root/mnt/vault
archvg-crypt    /mnt/root/mnt/crypt
</pre></div>
</td></tr></table></p>
<p>So I did:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo -s
mkdir -p /mnt/root/
mount /dev/disk/by-id/dm-name-archvg-archroot /mnt/root/
mkdir -p /mnt/root/boot
mount /dev/disk/by-id/dm-name-archvg-boot /mnt/root/boot
mkdir -p /mnt/root/var
mount /dev/disk/by-id/dm-name-archvg-archvar /mnt/root/var
mkdir -p /mnt/root/home
mount /dev/disk/by-id/dm-name-archvg-archhome /mnt/root/home
mkdir -p /mnt/root/mnt/vault
mount /dev/disk/by-id/dm-name-archvg-vault /mnt/root/mnt/vault
mkdir -p /mnt/root/mnt/crypt
mount /dev/disk/by-id/dm-name-archvg-crypt /mnt/root/mnt/crypt
swapon /dev/disk/by-id/dm-name-archvg-swap
swapon
lsblk <span class="c1"># check everything</span>
</pre></div>
</td></tr></table></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Control what you are mounting where with <code>lsblk</code>. You need do everything right before going <code>chroot</code>.</p>
</div>
<h3 id="chrooting">Chrooting<a class="headerlink" href="#chrooting" title="Permanent link">&para;</a></h3>
<p><a href="https://wiki.archlinux.org/index.php/change_root">Chroot</a> to the system:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>arch-chroot /mnt/root /bin/fish
</pre></div>
</td></tr></table>

<p>System maps filesystem data to current system.</p>
<h4 id="setup-the-bootloader">Setup the bootloader<a class="headerlink" href="#setup-the-bootloader" title="Permanent link">&para;</a></h4>
<p>On this system <a href="https://wiki.archlinux.org/index.php/GRUB">bootloader</a> was <a href="https://wiki.archlinux.org/index.php/GRUB#Master_Boot_Record_.28MBR.29_specific_instructions">this</a>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>pacman -Sy grub

lsblk

grub-install --target<span class="o">=</span>i386-pc /dev/sda

ls /boot/grub/grub.cfg*

diff /boot/grub/grub.cfg /boot/grub/grub.cfg.pacnew

grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</td></tr></table>

<h3 id="congratulations">Congratulations!<a class="headerlink" href="#congratulations" title="Permanent link">&para;</a></h3>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>After this you have fully restored system. So now you can reboot to your long awaited system and everything is going to run smooth.</p>
</div>
                
                  
                
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://blog.latukha.com/2017-05-04-Restore-of-deleted-LVM-(Advanced)/";
      this.page.identifier =
        "/2017-05-04-Restore-of-deleted-LVM-(Advanced)/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//blog-latukha-com.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../NixOS-HIE-Emacs/" title="Integrating NixOS/Nix, Haskell IDE Engine, Emacs" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Integrating NixOS/Nix, Haskell IDE Engine, Emacs
              </span>
            </div>
          </a>
        
        
          <a href="../2017-04-14-How-to-setup-proxy-to-listen-Spotify/" title="How to setup proxy to listen Spotify" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                How to setup proxy to listen Spotify
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            2016-2019 Anton Latukha, Creative Commons ShareAlike
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Anton-Latukha" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://gitlab.com/Anton.Latukha" target="_blank" rel="noopener" title="gitlab" class="md-footer-social__link fa fa-gitlab"></a>
    
      <a href="https://twitter.com/piroxiline" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/anton-latukha-2a286690" target="_blank" rel="noopener" title="linkedin" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://github.com/Anton-Latukha/Anton-Latukha.github.io/raw/master/assets/docs/AntonLatukhaCV.pdf" target="_blank" rel="noopener" title="handshake-o" class="md-footer-social__link fa fa-handshake-o"></a>
    
      <a href="https://github.com/Anton-Latukha/Anton-Latukha.github.io/raw/master/assets/docs/AntonLatukhaCV.pdf" target="_blank" rel="noopener" title="download" class="md-footer-social__link fa fa-download"></a>
    
      <a href="https://wiki.archlinux.org/index.php/Special:Contributions/Anton_Latukha" target="_blank" rel="noopener" title="linux" class="md-footer-social__link fa fa-linux"></a>
    
      <a href="https://wiki.archlinux.org/index.php/Special:Contributions/PiroXiline" target="_blank" rel="noopener" title="linux" class="md-footer-social__link fa fa-linux"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.970603a6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>